use strict;
use warnings;

use Test::More;

use ChronoBit::Bitcoin;
use ChronoBit::Util;
use ChronoBit::SHAState;

BEGIN { use_ok('ChronoBit::ProofStep'); }

my $test_msg1 = <DATA>;
my $known_serialization = <DATA>;
chomp $known_serialization;

my $msg1 = substr($test_msg1, 0, 113);
my $msg2 = substr($test_msg1, 113, 90);
my $msg3 = substr($test_msg1, 203);

my $ps = ChronoBit::ProofStep->new(
	normal => {
		state => ChronoBit::SHAState->new(len => 0, state => ''),
		prefix => $msg1,
		suffix => $msg3,
	},
);

is(bin2hex($ps->perform($msg2)), 
	'35314b8ce740af950adbf892d62886f8e1ec5d5c197fdc9577479832bb5825a0');

my $ps1_bin = $ps->dump;
is(bin2hex($ps1_bin), $known_serialization);

my $ps2 = ChronoBit::ProofStep->new_from_binary($ps1_bin);
is($ps2->dump, $ps1_bin);

done_testing;

# the data is long enough to exceed 255 bytes in var_ints

__DATA__
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Quisque sit amet enim ipsum, sit amet elementum justo. Vivamus sed felis erat, ac convallis eros. Quisque nisi felis, dignissim a pulvinar id, sagittis ut ante. Aliquam erat volutpat. Fusce dolor lectus, porttitor nec tincidunt ut, adipiscing id magna. Nulla vel massa aliquam augue luctus suscipit non eu sapien. Pellentesque nulla nulla, varius a venenatis vitae, mattis ac odio. Vestibulum vitae nibh sit amet ipsum sodales cursus. Vivamus id lacus dolor. Donec vel quam enim. Ut vel dui non lectus lacinia iaculis.  Curabitur ullamcorper malesuada metus eget molestie. Nunc vitae nisi eu mauris pellentesque tempor. Suspendisse tempor lobortis justo, sit amet bibendum augue feugiat eget. Curabitur faucibus sollicitudin arcu quis sodales. Nam blandit facilisis orci ut scelerisque. Aenean consectetur velit eget leo viverra in sollicitudin tortor placerat. Aliquam auctor diam dapibus sem bibendum eu posuere dui gravida. Ut vestibulum luctus laoreet. Donec et sollicitudin est. Suspendisse potenti. Nullam lorem odio, gravida vel egestas sit amet, accumsan non nulla. Etiam risus metus, venenatis id dictum eu, ultrices id nibh. Phasellus eu neque non ante malesuada congue. Praesent pharetra eleifend diam.  Ut quis vehicula odio. Vestibulum lacinia leo at nisl tincidunt nec viverra arcu laoreet. Aenean ullamcorper hendrerit lobortis. Fusce sodales massa id nibh mattis luctus. Pellentesque non libero vel neque bibendum fermentum sed at justo. Aenean porta, erat et lobortis fermentum, felis massa mattis ligula, nec consectetur nibh ante at mi. Donec at massa dui. Integer vitae nunc a nulla condimentum faucibus. Donec nec est turpis, nec vulputate magna. Morbi semper elit et leo vehicula suscipit. Sed fringilla, mauris sit amet dictum porta, libero elit bibendum magna, cursus aliquet sapien arcu vel nisi. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Lorem ipsum dolor sit amet, consectetur adipiscing elit.  Nulla eu dolor eget arcu luctus elementum. Proin vel lorem tellus, eget eleifend enim. Fusce sem dui, lacinia ut vulputate at, tempor aliquet lectus. Duis non diam vel eros tristique convallis. Phasellus quam ipsum, congue nec interdum in, sagittis ut est. Aenean pharetra fringilla mi, in molestie tellus laoreet semper. Proin a odio turpis, non lobortis justo. Mauris faucibus tortor sed arcu ullamcorper varius. Suspendisse potenti. Pellentesque pharetra posuere congue. Donec id nulla justo, ut tempus erat. Etiam eget placerat libero. Cras sit amet magna a velit pharetra mattis.  Praesent dui mi, scelerisque vitae tincidunt vitae, bibendum eu sem. In hac habitasse platea dictumst. Morbi at consectetur est. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Mauris nulla massa, viverra non faucibus nec, ornare vel lectus. Etiam non neque ut diam iaculis consectetur. Nulla vitae erat dapibus nunc dapibus hendrerit. Nullam tempus lorem ut elit consequat in faucibus massa tincidunt. Ut nec auctor nulla. Mauris cursus adipiscing dignissim. Aenean pretium, eros egestas rutrum sollicitudin, turpis libero lobortis felis, quis fringilla ligula eros sit amet turpis. Nulla dapibus urna ac metus volutpat sed tristique nisi volutpat.
0000714c6f72656d20697073756d20646f6c6f722073697420616d65742c20636f6e73656374657475722061646970697363696e6720656c69742e20517569737175652073697420616d657420656e696d20697073756d2c2073697420616d657420656c656d656e74756d206a7573746f2e2056fd1c0c697474697320757420616e74652e20416c697175616d206572617420766f6c75747061742e20467573636520646f6c6f72206c65637475732c20706f72747469746f72206e65632074696e636964756e742075742c2061646970697363696e67206964206d61676e612e204e756c6c612076656c206d6173736120616c697175616d206175677565206c7563747573207375736369706974206e6f6e2065752073617069656e2e2050656c6c656e746573717565206e756c6c61206e756c6c612c2076617269757320612076656e656e617469732076697461652c206d6174746973206163206f64696f2e20566573746962756c756d207669746165206e6962682073697420616d657420697073756d20736f64616c6573206375727375732e20566976616d7573206964206c6163757320646f6c6f722e20446f6e65632076656c207175616d20656e696d2e2055742076656c20647569206e6f6e206c6563747573206c6163696e696120696163756c69732e202043757261626974757220756c6c616d636f72706572206d616c657375616461206d657475732065676574206d6f6c65737469652e204e756e63207669746165206e697369206575206d61757269732070656c6c656e7465737175652074656d706f722e2053757370656e64697373652074656d706f72206c6f626f72746973206a7573746f2c2073697420616d657420626962656e64756d206175677565206665756769617420656765742e2043757261626974757220666175636962757320736f6c6c696369747564696e2061726375207175697320736f64616c65732e204e616d20626c616e64697420666163696c69736973206f726369207574207363656c657269737175652e2041656e65616e20636f6e73656374657475722076656c69742065676574206c656f207669766572726120696e20736f6c6c696369747564696e20746f72746f7220706c6163657261742e20416c697175616d20617563746f72206469616d20646170696275732073656d20626962656e64756d20657520706f73756572652064756920677261766964612e20557420766573746962756c756d206c7563747573206c616f726565742e20446f6e656320657420736f6c6c696369747564696e206573742e2053757370656e646973736520706f74656e74692e204e756c6c616d206c6f72656d206f64696f2c20677261766964612076656c20656765737461732073697420616d65742c20616363756d73616e206e6f6e206e756c6c612e20457469616d207269737573206d657475732c2076656e656e617469732069642064696374756d2065752c20756c747269636573206964206e6962682e2050686173656c6c7573206575206e65717565206e6f6e20616e7465206d616c65737561646120636f6e6775652e205072616573656e7420706861726574726120656c656966656e64206469616d2e202055742071756973207665686963756c61206f64696f2e20566573746962756c756d206c6163696e6961206c656f206174206e69736c2074696e636964756e74206e656320766976657272612061726375206c616f726565742e2041656e65616e20756c6c616d636f727065722068656e647265726974206c6f626f727469732e20467573636520736f64616c6573206d61737361206964206e696268206d6174746973206c75637475732e2050656c6c656e746573717565206e6f6e206c696265726f2076656c206e6571756520626962656e64756d206665726d656e74756d20736564206174206a7573746f2e2041656e65616e20706f7274612c2065726174206574206c6f626f72746973206665726d656e74756d2c2066656c6973206d61737361206d6174746973206c6967756c612c206e656320636f6e7365637465747572206e69626820616e7465206174206d692e20446f6e6563206174206d61737361206475692e20496e7465676572207669746165206e756e632061206e756c6c6120636f6e64696d656e74756d2066617563696275732e20446f6e6563206e656320657374207475727069732c206e65632076756c707574617465206d61676e612e204d6f7262692073656d70657220656c6974206574206c656f207665686963756c612073757363697069742e20536564206672696e67696c6c612c206d61757269732073697420616d65742064696374756d20706f7274612c206c696265726f20656c697420626962656e64756d206d61676e612c2063757273757320616c69717565742073617069656e20617263752076656c206e6973692e20436c61737320617074656e742074616369746920736f63696f737175206164206c69746f726120746f727175656e742070657220636f6e75626961206e6f737472612c2070657220696e636570746f732068696d656e61656f732e204c6f72656d20697073756d20646f6c6f722073697420616d65742c20636f6e73656374657475722061646970697363696e6720656c69742e20204e756c6c6120657520646f6c6f7220656765742061726375206c756374757320656c656d656e74756d2e2050726f696e2076656c206c6f72656d2074656c6c75732c206567657420656c656966656e6420656e696d2e2046757363652073656d206475692c206c6163696e69612075742076756c7075746174652061742c2074656d706f7220616c6971756574206c65637475732e2044756973206e6f6e206469616d2076656c2065726f732074726973746971756520636f6e76616c6c69732e2050686173656c6c7573207175616d20697073756d2c20636f6e677565206e656320696e74657264756d20696e2c207361676974746973207574206573742e2041656e65616e207068617265747261206672696e67696c6c61206d692c20696e206d6f6c65737469652074656c6c7573206c616f726565742073656d7065722e2050726f696e2061206f64696f207475727069732c206e6f6e206c6f626f72746973206a7573746f2e204d617572697320666175636962757320746f72746f7220736564206172637520756c6c616d636f72706572207661726975732e2053757370656e646973736520706f74656e74692e2050656c6c656e74657371756520706861726574726120706f737565726520636f6e6775652e20446f6e6563206964206e756c6c61206a7573746f2c2075742074656d70757320657261742e20457469616d206567657420706c616365726174206c696265726f2e20437261732073697420616d6574206d61676e6120612076656c6974207068617265747261206d61747469732e20205072616573656e7420647569206d692c207363656c657269737175652076697461652074696e636964756e742076697461652c20626962656e64756d2065752073656d2e20496e206861632068616269746173736520706c617465612064696374756d73742e204d6f72626920617420636f6e7365637465747572206573742e2043756d20736f63696973206e61746f7175652070656e617469627573206574206d61676e6973206469732070617274757269656e74206d6f6e7465732c206e61736365747572207269646963756c7573206d75732e204d6175726973206e756c6c61206d617373612c2076697665727261206e6f6e206661756369627573206e65632c206f726e6172652076656c206c65637475732e20457469616d206e6f6e206e65717565207574206469616d20696163756c697320636f6e73656374657475722e204e756c6c6120766974616520657261742064617069627573206e756e6320646170696275732068656e6472657269742e204e756c6c616d2074656d707573206c6f72656d20757420656c697420636f6e73657175617420696e206661756369627573206d617373612074696e636964756e742e205574206e656320617563746f72206e756c6c612e204d6175726973206375727375732061646970697363696e67206469676e697373696d2e2041656e65616e207072657469756d2c2065726f7320656765737461732072757472756d20736f6c6c696369747564696e2c20747572706973206c696265726f206c6f626f727469732066656c69732c2071756973206672696e67696c6c61206c6967756c612065726f732073697420616d6574207475727069732e204e756c6c6120646170696275732075726e61206163206d6574757320766f6c75747061742073656420747269737469717565206e69736920766f6c75747061742e0a
